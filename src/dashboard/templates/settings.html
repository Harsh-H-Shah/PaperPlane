{% extends "base.html" %}
{% block title %}Settings - AutoApplier{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Settings</h1>
        <p class="page-subtitle">Scraper configuration and status</p>
    </div>

    <!-- Scrapers -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <span class="card-title">Scrapers</span>
        </div>
        <div class="settings-grid" id="scrapers-grid">
            <div class="loading-more"><div class="loading-spinner"></div></div>
        </div>
    </div>

    <!-- Actions -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Actions</span>
        </div>
        <div style="display: flex; gap: 12px; flex-wrap: wrap;">
            <button onclick="triggerScrape()" class="btn btn-primary" id="scrape-btn">
                Scrape All Sources
            </button>
            <button onclick="clearJobs()" class="btn btn-ghost">
                Clear All Jobs
            </button>
        </div>
        <p id="action-status" style="margin-top: 12px; font-size: 0.85rem; color: var(--text-muted);"></p>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', loadSettings);

async function loadSettings() {
    try {
        const res = await fetch('/api/scrapers/status');
        const data = await res.json();
        
        const grid = document.getElementById('scrapers-grid');
        grid.innerHTML = data.scrapers.map(scraper => `
            <div class="scraper-card">
                <div class="scraper-icon">${scraper.icon}</div>
                <div class="scraper-info">
                    <div class="scraper-name">${scraper.name}</div>
                    <div class="scraper-status">${scraper.note || (scraper.configured ? 'Ready to use' : 'Not configured')}</div>
                </div>
                <span class="scraper-badge ${scraper.configured ? 'active' : 'config'}">
                    ${scraper.configured ? 'Active' : 'Setup'}
                </span>
            </div>
        `).join('');
    } catch (e) {
        console.error('Failed to load settings:', e);
    }
}

async function triggerScrape() {
    const btn = document.getElementById('scrape-btn');
    btn.classList.add('loading');
    btn.textContent = 'Scraping...';
    document.getElementById('action-status').textContent = 'Scraping started in background...';
    
    try {
        await fetch('/api/scrape', { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify({ limit: 100 }) 
        });
        
        setTimeout(() => {
            btn.classList.remove('loading');
            btn.textContent = 'Scrape All Sources';
            document.getElementById('action-status').textContent = 'Scraping complete! Check the Jobs page for new entries.';
        }, 5000);
    } catch (e) {
        btn.classList.remove('loading');
        btn.textContent = 'Scrape All Sources';
        document.getElementById('action-status').textContent = 'Error: ' + e.message;
    }
}

async function clearJobs() {
    if (!confirm('Are you sure you want to delete all jobs?')) return;
    document.getElementById('action-status').textContent = 'Feature not yet implemented.';
}
</script>
{% endblock %}
