{% extends "base.html" %}
{% block title %}Dashboard - AutoApplier{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">Dashboard</h1>
        <p class="page-subtitle">Overview of your job applications</p>
    </div>

    <!-- Search Overlay -->
    <div class="search-hero">
        <input type="text" class="search-input-large" id="dash-search" placeholder="Search jobs database..." onkeydown="handleHeroSearch(event)">
    </div>

    <!-- Stats -->
    <div class="stats-grid">
        <a href="/jobs" class="stat-card total clickable">
            <div class="stat-value" id="stat-total">—</div>
            <div class="stat-label">Total Jobs</div>
        </a>
        <a href="/jobs?status=applied" class="stat-card applied clickable">
            <div class="stat-value" id="stat-applied">—</div>
            <div class="stat-label">Applied</div>
        </a>
        <a href="/jobs?status=new" class="stat-card pending clickable">
            <div class="stat-value" id="stat-pending">—</div>
            <div class="stat-label">Pending</div>
        </a>
        <a href="/jobs?status=failed" class="stat-card failed clickable">
            <div class="stat-value" id="stat-failed">—</div>
            <div class="stat-label">Failed</div>
        </a>
        <a href="/jobs?status=needs_review" class="stat-card needs-review clickable">
            <div class="stat-value" id="stat-review">—</div>
            <div class="stat-label">Needs Review</div>
        </a>
        <a href="/jobs?status=expired" class="stat-card expired clickable">
            <div class="stat-value" id="stat-expired">—</div>
            <div class="stat-label">Expired</div>
        </a>
        <div class="stat-card tokens">
            <div class="stat-value" id="stat-tokens">—</div>
            <div class="stat-label">LLM Tokens</div>
        </div>
    </div>

    <!-- Sources Chart -->
    <div class="card" style="margin-bottom: 24px;">
        <div class="card-header">
            <span class="card-title">Jobs by Source</span>
            <button onclick="triggerScrape()" class="btn btn-primary" id="scrape-btn">
                Scrape New Jobs
            </button>
        </div>
        <div class="sources-list" id="sources-list">
            <div class="loading-more"><div class="loading-spinner"></div></div>
        </div>
    </div>

    <!-- Recent Applications -->
    <div class="card">
        <div class="card-header">
            <span class="card-title">Recent Applications</span>
            <a href="/jobs" class="btn btn-ghost">View All →</a>
        </div>
        <div class="jobs-list" id="recent-jobs">
            <div class="loading-more"><div class="loading-spinner"></div></div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', loadDashboard);

async function loadDashboard() {
    try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        
        // Update stats
        document.getElementById('stat-total').textContent = data.total;
        document.getElementById('stat-applied').textContent = data.applied;
        document.getElementById('stat-pending').textContent = data.pending;
        document.getElementById('stat-failed').textContent = data.failed;
        document.getElementById('stat-review').textContent = data.needs_review || 0;
        document.getElementById('stat-expired').textContent = data.expired || 0;
        
        // Fetch LLM Usage
        try {
            const llmRes = await fetch('/api/llm-usage');
            const llmData = await llmRes.json();
            if (llmData.monthly_tokens !== undefined) {
                const used = (llmData.monthly_tokens / 1000).toFixed(1) + 'k';
                const limit = (llmData.monthly_limit / 1000).toFixed(0) + 'k';
                document.getElementById('stat-tokens').textContent = `${used} / ${limit}`;
                document.getElementById('stat-tokens').title = `${llmData.monthly_tokens} used of ${llmData.monthly_limit} limit`;
            } else {
                document.getElementById('stat-tokens').textContent = 'N/A';
            }
        } catch (e) {
            document.getElementById('stat-tokens').textContent = 'Err';
        }
        
        // Render sources
        const sourcesList = document.getElementById('sources-list');
        const sources = Object.entries(data.by_source || {});
        const maxCount = Math.max(...sources.map(([, c]) => c), 1);
        
        if (sources.length === 0) {
            sourcesList.innerHTML = '<div class="empty-state">No jobs scraped yet</div>';
        } else {
            sourcesList.innerHTML = sources.map(([name, count]) => `
                <div class="source-item">
                    <span class="source-name">${formatSource(name)}</span>
                    <div class="source-bar">
                        <div class="source-bar-fill" style="width: ${(count / maxCount) * 100}%"></div>
                    </div>
                    <span class="source-count">${count}</span>
                </div>
            `).join('');
        }
        
        // Load recent jobs
        const jobsRes = await fetch('/api/jobs?per_page=5');
        const jobsData = await jobsRes.json();
        
        const recentJobs = document.getElementById('recent-jobs');
        if (jobsData.jobs.length === 0) {
            recentJobs.innerHTML = '<div class="empty-state">No jobs yet. Click "Scrape New Jobs" to start.</div>';
        } else {
            recentJobs.innerHTML = jobsData.jobs.map(job => `
                <div class="job-item">
                    <div class="job-info">
                        <div class="job-title">
                            <a href="${escapeHtml(job.url)}" target="_blank">${escapeHtml(job.title)}</a>
                        </div>
                        <div class="job-meta">
                            <span class="job-company">${escapeHtml(job.company) || 'Unknown'}</span>
                            <span>${escapeHtml(job.location) || ''}</span>
                        </div>
                    </div>
                    <span class="job-source">${formatSource(job.source)}</span>
                    <span class="job-status ${job.status}">${job.status}</span>
                    <span class="job-date">${formatDate(job.discovered_at)}</span>
                </div>
            `).join('');
        }
    } catch (e) {
        console.error('Failed to load dashboard:', e);
    }
}

async function triggerScrape() {
    const btn = document.getElementById('scrape-btn');
    if (btn.classList.contains('loading')) return;
    
    btn.classList.add('loading');
    btn.textContent = 'Starting...';
    
    try {
        await fetch('/api/scrape', { method: 'POST', headers: {'Content-Type': 'application/json'}, body: '{}' });
        
        // Poll for progress
        const interval = setInterval(async () => {
            try {
                const res = await fetch('/api/scrape/progress');
                const status = await res.json();
                
                if (status.is_running) {
                    btn.textContent = `Scraping ${status.current_source}... (${status.jobs_found} raw, ${status.jobs_new} new)`;
                } else {
                    clearInterval(interval);
                    btn.classList.remove('loading');
                    btn.textContent = `Done! Found ${status.jobs_new} new (${status.jobs_found} total scanned)`;
                    setTimeout(() => { btn.textContent = 'Scrape New Jobs'; }, 5000);
                    loadDashboard();
                }
            } catch (e) {
                clearInterval(interval);
                btn.classList.remove('loading');
                btn.textContent = 'Scrape New Jobs';
            }
        }, 1000);
        
    } catch (e) {
        btn.classList.remove('loading');
        btn.textContent = 'Error starting scrape';
        setTimeout(() => { btn.textContent = 'Scrape New Jobs'; }, 2000);
    }
}

function handleHeroSearch(e) {
    if (e.key === 'Enter') {
        const term = e.target.value;
        if (term) {
            window.location.href = `/jobs?search=${encodeURIComponent(term)}`;
        }
    }
}
</script>
{% endblock %}
